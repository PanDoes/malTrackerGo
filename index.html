<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>malTrackerGo</title>
    <script>
        window.$ = window.jQuery = require('jquery');
    </script>

    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
    <link href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" rel="stylesheet">

    <script src="node_modules/jquery-tags-input/src/jquery.tagsinput.js"></script>
    <link rel="stylesheet" type="text/css" href="node_modules/jquery-tags-input/src/jquery.tagsinput.css" />

    <script defer src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>

    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">

    <script src="scripts/jscolor.js"></script>

    <link rel="stylesheet" href="default.css" />
    <script src="default.js"></script>

    <script type="text/javascript">
        function loadRSS(users) {
            users = users.split("=")[1];
            users = users.replace(/%2C/g, ",");
            console.log("Feed Loaded.");

            let RSSCombiner = require('rss-combiner');
            feedList = [];
            url = "https://myanimelist.net/rss.php?type=rw&u="

            users = users.split(",");

            users.forEach(user => {
                feedList.push(url + user);
            });

            // console.log(feedList);

            var feedConfig = {
                size: 20,
                feeds: feedList,
                pubDate: new Date()
            };

            var xml;

            RSSCombiner(feedConfig, function(err, combinedFeed) {
                if (err) {
                    console.error(err);
                } else {
                    xml = combinedFeed.xml({
                        indent: true
                    });
                    let Parser = require('rss-parser');
                    let parser = new Parser();

                    (async() => {
                        var content = document.getElementById("display");

                        let feed = await parser.parseString(xml);
                        // console.log(feed.title);

                        document.getElementById("display").innerHTML = "";
                        feed.items.forEach(item => {
                            // console.log(item);
                            var div = document.createElement("div");
                            div.setAttribute('class', "item");

                            var a = document.createElement("a");
                            a.textContent = item.title;
                            a.setAttribute('href', item.link);
                            a.setAttribute('target', "_blank");

                            var pubDate = document.createElement("div");
                            var d = new Date(item.pubDate.split("-")[0]);
                            pubDate.textContent = d.toLocaleDateString() + " at " + d.toLocaleTimeString();
                            pubDate.setAttribute("class", "date");

                            var desc = document.createElement("p");
                            desc.textContent = item.content;

                            var person = document.createElement("a");
                            person.textContent = item.creator.split("=")[2];
                            person.setAttribute('class', "person");
                            person.setAttribute('target', "_blank");
                            person.setAttribute("href", "https://myanimelist.net/profile/" + item.creator.split("=")[2]);

                            div.appendChild(a);
                            div.appendChild(pubDate);
                            div.appendChild(desc);
                            div.appendChild(person);
                            content.appendChild(div);
                        });

                    })();
                }
            });
        }

        function applySettings(color1, color2) {
            document.getElementsByTagName("html")[0].style.background = "linear-gradient(to bottom right, #" + color1 + ",#" + color2 + ")";
        }
        //document ready
        $(document).ready(function() {
            $('#tagsFriends').tagsInput();

            document.getElementById("btnLoad").click();

            document.getElementById("btnSettings").addEventListener("click", function() {
                document.body.style.overflow = "hidden";
                document.getElementById("content").style.webkitFilter = "blur(2px) brightness(80%)";
                $(".modal").show('clip', {}, 200);
            });

            document.getElementById("settingsModal").addEventListener("click", function(e) {
                if (e.target !== this)
                    return;
                document.body.style.overflow = "scroll";
                document.getElementById("content").style.webkitFilter = "blur(0px) brightness(100%)";
                $(".modal").hide('clip', {}, 200);
            });
        });
    </script>
</head>

<body>
    <div class="buffer"></div>
    <div id="content">
        <form>
            <input name="tags" id="tagsFriends" value="Badtz13,Pandoes,Fandango86,crazyawesome" />
        </form>
        <div class="rightButtons">
            <button id="btnLoad" onclick="loadRSS($('form').serialize())">Refresh</button>
            <button id="btnSettings"><i class="fas fa-cog"></i></button>
        </div>
        <div id="display">
        </div>
    </div>

    <!-- modal code -->
    <div id="settingsModal" style="display:none" class="modal">
        <div class="modalContent modal">
            <p class="modalHeader">Settings</p>
            <form id="settingsForm">
                <input type="text" id="color1" class="jscolor" />
                <input type="text" id="color2" class="jscolor" />
            </form>
            <button id="settingsSubmit" onclick="applySettings($('#color1').val(),$('#color2').val())">Save</button>
        </div>
    </div>

</body>

<script>
    // code for auto pull feed

    // resets the timer
    function refresh() {
        clearTimeout(timer);
        timer = setTimeout(function() {
            document.getElementById("btnLoad").click()
            refresh();
        }, 5000);
    };

    // creates the timer
    timer = setTimeout(function() {
        document.getElementById("btnLoad").click();
    }, 5000);

    // calls reset timer function if user is active 
    $(document).on('keypress, click, mousemove', refresh);
</script>

</html>