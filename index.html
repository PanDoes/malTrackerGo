<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>malTrackerGo</title>
    <script>
        window.$ = window.jQuery = require('jquery');
    </script>

    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
    <link href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" rel="stylesheet">

    <script src="node_modules/jquery-tags-input/src/jquery.tagsinput.js"></script>
    <link rel="stylesheet" type="text/css" href="node_modules/jquery-tags-input/src/jquery.tagsinput.css" />

    <script defer src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>

    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">

    <script src="scripts/jscolor.js"></script>

    <link rel="stylesheet" href="default.css" />

    <script type="text/javascript">
        // require dependencies
        const fs = require('fs'); // File systems
        const util = require('util');
        const path = require('path');
        const RSSCombiner = require('rss-combiner');
        const readFile = util.promisify(fs.readFile);
        const Parser = require('rss-parser');

        // setup global variables 
        var pathSet = path.join(__dirname, 'settings.txt'); // Path to the settings file
        var setFull = null;
        var setStatuses = null;
        var setColors = null;
        var ptw = false;
        var cpl = false;
        var oh = false;
        var d = false;
        var w = false;
        var feedSize = 15;
        var firstColor = "";
        var secondColor = "";
        var i = null;
        var users = [];
        var colorsArray = [];
        var loaded = false;

        // create async function to get data from settings file with a promise
        async function getData() {
            return await readFile(pathSet, 'utf-8');
        }

        // load merged rss feed
        function loadRSS() {

            // create list of non filtered statuses
            var activeStatuses = [];
            if (ptw) {
                activeStatuses.push("Plan to Watch");
            }
            if (cpl) {
                activeStatuses.push("Completed");
            }
            if (oh) {
                activeStatuses.push("On-hold");
            }
            if (d) {
                activeStatuses.push("Dropped");
            }
            if (w) {
                activeStatuses.push("Watching");
            }

            // create list of rss feeds from usernames
            feedList = [];
            url = "https://myanimelist.net/rss.php?type=rw&u="
            for (var h = 0; h < users.length; h++) {
                feedList.push(url + users[h]);
            }

            var getTagElements = document.getElementsByClassName("tag");
            for (var y = 0; y < colorsArray.length; y++) {
                if (getTagElements[y]) {
                    getTagElements[y].style.setProperty("background-color", "#" + colorsArray[y][1], "important");
                }
            }

            // create config for rss combiner
            var feedConfig = {
                size: 1000,
                feeds: feedList,
                pubDate: new Date()
            };

            // combine feeds
            RSSCombiner(feedConfig, function(err, combinedFeed) {
                if (err) {
                    console.error(err);
                } else {
                    var xml = combinedFeed.xml({
                        indent: true
                    });
                    let parser = new Parser();

                    // after the feeds are parsed together...
                    (async() => {
                        var content = document.getElementById("display"); // main containing div

                        let feed = await parser.parseString(xml);

                        document.getElementById("display").innerHTML = ""; // clear old feed display

                        var matchCount = 0; // keeps track of the number of filter matching items

                        for (var i = 0; i < feed.items.length; i++) { // loop through all feed items
                            var item = feed.items[i];

                            // check if the feed item matches filters
                            var status = item.content.split(" - ")[0];
                            if (activeStatuses.includes(status)) {

                                if (matchCount == feedSize) { // if max feed size is hit, break
                                    break;
                                }

                                // create feed item element
                                var div = document.createElement("div");
                                div.setAttribute('class', "item");

                                for (var v = 0; v < colorsArray.length; v++) {
                                    if (colorsArray[v][0] == item.creator.split("=")[2]) {
                                        div.setAttribute('style', "border-right: 3px solid #" + colorsArray[v][1]);
                                    }
                                }

                                var a = document.createElement("a");
                                a.textContent = item.title;
                                a.setAttribute('href', item.link);
                                a.setAttribute('target', "_blank");

                                var pubDate = document.createElement("div");
                                var d = new Date(item.pubDate.split("-")[0]);
                                pubDate.textContent = d.toLocaleDateString() + " at " + d.toLocaleTimeString();
                                pubDate.setAttribute("class", "date");

                                var desc = document.createElement("p");
                                desc.textContent = item.content;

                                var person = document.createElement("a");
                                person.textContent = item.creator.split("=")[2];
                                person.setAttribute('class', "person " + item.creator.split("=")[2]);
                                person.setAttribute('target', "_blank");
                                person.setAttribute("href", "https://myanimelist.net/profile/" + item.creator.split("=")[2]);

                                div.appendChild(a);
                                div.appendChild(pubDate);
                                div.appendChild(desc);
                                div.appendChild(person);
                                content.appendChild(div);
                                matchCount++;
                            }

                        }
                        // fix background gradient on less items than fill screen
                        if (window.innerHeight > document.getElementById("content").clientHeight) {
                            document.getElementsByTagName("html")[0].style.height = "100%";
                        } else {
                            document.getElementsByTagName("html")[0].style.height = "";
                        }
                    })();
                }
            });
        }
        // apply changes to settings, and store them in settings file
        function applySettings(color1, color2, fptw, fcpl, foh, fd, fw, ffeedSize) {
            ptw = fptw;
            cpl = fcpl;
            oh = foh;
            d = fd;
            w = fw;
            feedSize = ffeedSize;
            firstColor = "#" + color1;
            secondColor = "#" + color2;

            // save settings to file
            fs.writeFile(pathSet, cpl + "," + w + "," + ptw + "," + oh + "," + d + ",\n" + firstColor.substring(1) + "," + secondColor.substring(1) + ",\n" + feedSize + ",\n" + users.join(","),
                function(err) {
                    if (err) throw err;
                });
            document.getElementsByTagName("html")[0].style.background = "linear-gradient(to bottom right, #" + color1 + ",#" + color2 + ")";
            document.getElementById("btnLoad").click();
            document.getElementById("settingsModal").click();
        }

        // apply tag colors
        function saveTagColor(color, user) {
            var tagElementList = document.getElementsByClassName("tag");
            for (var i = 0; i < tagElementList.length; i++) {
                var currentTag = tagElementList[i].innerHTML.split("&")[0];
                currentTag = currentTag.split(">")[1];
                if (currentTag == user) {
                    tagElementList[i].style.setProperty("background-color", "#" + color, "important");
                }
            }
            var found = false;
            for (var v = 0; v < colorsArray.length; v++) {
                if (colorsArray[v][0] == user) {
                    colorsArray[v][1] = color;
                    found = true;
                }
            }
            if (found == false) {
                colorsArray.push([user, color]);
            }

            // document.getElementById("btnLoad").click();
            document.getElementById("colorModal").click();
        }

        // setup auto color update in settings
        function previewColors() {
            var pre1 = $('#color1').val();
            var pre2 = $('#color2').val();
            document.getElementsByTagName("html")[0].style.background = "linear-gradient(to bottom right, #" + pre1 + ",#" + pre2 + ")";
        }

        // document ready setup
        $(document).ready(function() {

            // setup tag input
            $('#tagsFriends').tagsInput({
                onChange: function() {
                    var tempUsers = $('form').serialize().split("=")[1];
                    tempUsers = tempUsers.split("%2C");
                    users = tempUsers;

                    var getTagElements = document.getElementsByClassName("tag");
                    for (var y = 0; y < colorsArray.length; y++) {
                        if (getTagElements[y]) {
                            getTagElements[y].style.setProperty("background-color", "#" + colorsArray[y][1], "important");
                        }
                    }
                    if (loaded) {
                        for (var k = colorsArray.length; k < users.length; k++) {
                            colorsArray.push([users[k], "none"]);
                        }
                        document.getElementById("btnLoad").click();
                    }
                }
            });

            // load data from file
            getData().then(data => {
                setFull = data.split("\n");
                setStatuses = setFull[0].split(",");
                setColors = setFull[1].split(",");
                for (i = 0; i < 5; ++i) {
                    if (setStatuses[i] == "true") {
                        setStatuses[i] = true;
                    } else {
                        setStatuses[i] = false;
                    }
                }
                cpl = setStatuses[0];
                w = setStatuses[1];
                ptw = setStatuses[2];
                oh = setStatuses[3];
                d = setStatuses[4];
                firstColor = setColors[0];
                secondColor = setColors[1];
                feedSize = parseInt(setFull[2].split(",")[0]);
                users = setFull[3].split(",");
                var colorList = [];
                for (var u = 0; u < users.length; u++) {
                    if (colorList[u]) {
                        colorsArray[u] = [users[u], colorList[u]];
                    } else {
                        colorsArray[u] = [users[u], "none"];
                    }
                }
                $('#tagsFriends').importTags(setFull[3]);
                // once data is loaded, apply settings from file and render page
                applySettings(firstColor, secondColor, ptw, cpl, oh, d, w, feedSize);
                loaded = true;
            });

            // setup feedsize slider
            $("#feedSize").slider({
                min: 5,
                max: 100,
                step: 5,
                slide: function(event, ui) {
                    $('#sliderDisplay').html(ui.value);
                }
            });

            // setup settings button
            document.getElementById("btnSettings").addEventListener("click", function() {

                $('#ptw').prop('checked', ptw);
                $('#cpl').prop('checked', cpl);
                $('#oh').prop('checked', oh);
                $('#d').prop('checked', d);
                $('#w').prop('checked', w);

                document.getElementById("color1").jscolor.fromString(firstColor.split("#")[1]);
                document.getElementById("color2").jscolor.fromString(secondColor.split("#")[1]);

                $("#feedSize").slider("value", feedSize);
                $('#sliderDisplay').html(feedSize);

                document.body.style.overflow = "hidden";
                document.getElementById("content").style.webkitFilter = "blur(2px) brightness(80%)";
                $(".modal").show('clip', {}, 200);
            });

            // setup close modal
            document.getElementById("settingsModal").addEventListener("click", function(e) {
                if (e.target !== this)
                    return;
                document.body.style.overflow = "scroll";
                document.getElementsByTagName("html")[0].style.background = "linear-gradient(to bottom right,#" + firstColor.split("#")[1] + ",#" + secondColor.split("#")[1] + ")";
                document.getElementById("content").style.webkitFilter = "blur(0px) brightness(100%)";
                $(".modal").hide('clip', {}, 200);
            });

            // tag color modal
            var tagElementList = document.getElementsByClassName("tagsinput");
            for (var i = 0; i < tagElementList.length; i++) {
                tagElementList[i].addEventListener("click", function(e) {
                    var target = e.target.innerHTML.split("&")[0];
                    if (target) {
                        document.getElementById("colorPickerName").innerHTML = target;
                        if (e.target.parentElement.style.backgroundColor) {
                            document.getElementById("nameColorPicker").jscolor.fromString(e.target.parentElement.style.backgroundColor);
                        } else {
                            document.getElementById("nameColorPicker").jscolor.fromString("FFF");
                        }

                        document.body.style.overflow = "hidden";
                        document.getElementById("content").style.webkitFilter = "blur(2px) brightness(80%)";
                        $(".colorModal").show('clip', {}, 200);
                    }
                });
            }

            // close color modal on clickoff
            document.getElementById("colorModal").addEventListener("click", function(e) {
                if (e.target !== this)
                    return;
                document.body.style.overflow = "scroll";
                document.getElementById("content").style.webkitFilter = "blur(0px) brightness(100%)";
                $(".colorModal").hide('clip', {}, 200);
                document.getElementById("btnLoad").click();
            });
        });
    </script>
</head>

<body>
    <!-- draggable title bar -->
    <div class="buffer"></div>
    <!-- main content -->
    <div id="content">
        <form>
            <input name="tags" type="text" id="tagsFriends" value="Badtz13,PanDoes,Fandango86,crazyawesome" />
        </form>
        <div class="rightButtons">
            <button id="btnLoad" onclick="loadRSS()">Refresh</button>
            <button id="btnSettings"><i class="fas fa-cog"></i></button>
        </div>
        <div id="display">
        </div>
    </div>

    <!-- modal code -->
    <div id="settingsModal" style="display:none" class="modal">
        <div class="modalContent modal">
            <p class="modalHeader">Settings</p>
            <div class="modalLabel" id="backgroundLabel">Background Color</div>
            <input type="text" id="color1" class="jscolor {onFineChange:'previewColors()'}" />
            <input type="text" id="color2" class="jscolor {onFineChange:'previewColors()'}" />

            <div class="checkboxContainer">
                <div class="modalLabel" id="checkBoxLabel">Feed Filters</div>

                <input type="checkbox" id="cpl" class="checkbox" />
                <p class="label">Completed</p>

                <input type="checkbox" id="w" class="checkbox" />
                <p class="label">Watching</p>

                <input type="checkbox" id="ptw" class="checkbox" />
                <p class="label"> Plan to watch</p>

                <input type="checkbox" id="oh" class="checkbox" />
                <p class="label">On hold</p>

                <input type="checkbox" id="d" class="checkbox" />
                <p class="label">Dropped</p>

            </div>

            <div id="feedSize"></div>
            <button id="settingsSubmit" onclick="applySettings($('#color1').val(),$('#color2').val(),$('#ptw').prop('checked'),$('#cpl').prop('checked'),$('#oh').prop('checked'),$('#d').prop('checked'),$('#w').prop('checked'),$('#feedSize').slider('option','value'))">Save</button>
            <div class="modalLabel" id="feedSizeLabel">Feed Size</div>
            <div id="sliderDisplay"></div>
        </div>
    </div>
    <div id="colorModal" style="display:none" class="colorModal">
        <div class="modalContent colorModal" id="colorModalContent">
            <p class="modalHeader">Edit colors for
                <div id="colorPickerName"></div>
            </p>
            <input type="text" id="nameColorPicker" class="jscolor" />
            <button id="colorSubmit" onclick="saveTagColor($('#nameColorPicker').val(),$('#colorPickerName').text())">Save</button>
        </div>
    </div>

</body>

<script>
    // code for auto pull feed

    var timer;
    // resets the timer
    function refresh() {
        clearTimeout(timer);
        timer = setTimeout(function() {
            document.getElementById("btnLoad").click()
            refresh();
        }, 5000);
    };

    // creates the timer
    timer = setTimeout(function() {
        document.getElementById("btnLoad").click();
    }, 5000);

    // calls reset timer function if user is active 
    $(document).on('keypress, click, mousemove', refresh);
</script>

</html>